#!/usr/bin/env groovy

// Jenkinsfile that defines a declarative Jenkins pipeline that is used to seed Jenkins Job DSL configured jobs
// Job-DSL configuration for seedJobs is configured through the jobs.yaml Jenkins Configuration as Code file on boot
pipeline
{
    agent any

    options
    {
        timeout(time: 5, unit: 'MINUTES')
    }

    parameters
    {
        string(name: 'GIT_URL', defaultValue: 'https://github.com/Minreaux/jenkins-test', description: 'Specify the URL or path of the git repository. This uses the same syntax as your git clone command.', trim: true)
        string(name: 'DSL_SCRIPTS', defaultValue: 'jenkinsfiles/*.groovy', description: 'Newline separated list of DSL scripts, located in the Workspace. Can use wildcards like \'jobs/**/*.groovy\'. Scripts are executed in the same order as specified. The execution order of expanded wildcards is unspecified.', trim: true)
        choice(name: 'REMOVED_JOB_ACTION', choices: ['DISABLE', 'DELETE'], description: 'Specifies what to do when a previously generated job is not referenced anymore.')
    }

    stages
    {
        stage('Seeding Jobs')
        {
            steps
            {
                checkout(
                    scmGit(
                        branches: [[name: BRANCH_NAME]],
                        extensions: [[$class: 'SparseCheckoutPaths', sparseCheckoutPaths: [[path: params.DSL_SCRIPTS]]]],
                        userRemoteConfigs: [[url: params.GIT_URL]]
                    )
                )

                jobDsl(
                    failOnMissingPlugin: true,
                    failOnSeedCollision: true,
                    ignoreExisting: false,
                    ignoreMissingFiles: false,
                    lookupStrategy: 'JENKINS_ROOT',
                    removedConfigFilesAction: 'IGNORE',
                    removedJobAction: params.REMOVED_JOB_ACTION,
                    removedViewAction: 'IGNORE',
                    sandbox: true,
                    targets: params.DSL_SCRIPTS,
                    unstableOnDeprecation: true
                )
            }
        }
    }
}
